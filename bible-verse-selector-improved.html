<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ªçn C√¢u Kinh Th√°nh - With API & Filtered Books</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 40px;
            background: #f5f5f5;
        }

        .demo-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .demo-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .demo-description {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Bible Verse Selector Input */
        .bible-verse-selector-wrapper {
            position: relative;
            width: 100%;
        }

        .bible-verse-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            min-height: 48px;
            display: flex;
            align-items: center;
            position: relative;
        }

        .bible-verse-input:hover {
            border-color: #4CAF50;
        }

        .bible-verse-input.focused {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .input-placeholder {
            color: #999;
            font-style: italic;
        }

        .input-content {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            width: 100%;
        }

        .verse-tag {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .verse-tag-remove {
            cursor: pointer;
            color: #f44336;
            font-weight: bold;
            font-size: 14px;
            transition: color 0.2s;
        }

        .verse-tag-remove:hover {
            color: #c62828;
        }

        .input-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            pointer-events: none;
        }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        .modal-overlay.active {
            display: block;
        }

        /* Modal */
        .bible-verse-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .bible-verse-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .modal-close {
            cursor: pointer;
            font-size: 28px;
            color: #999;
            transition: color 0.2s;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        .selector-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .form-select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .verse-grid-container {
            margin-bottom: 20px;
            display: none;
        }

        .verse-grid-container.active {
            display: block;
        }

        .verse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }

        .verse-button {
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .verse-button:hover {
            border-color: #4CAF50;
            background: #f1f8f4;
        }

        .verse-button.range-start {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .verse-button.in-range {
            background: #81c784;
            color: white;
            border-color: #81c784;
        }

        .verse-button.range-end {
            background: #66bb6a;
            color: white;
            border-color: #66bb6a;
        }

        /* Tooltip for verse hover */
        .verse-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            max-width: 400px;
            z-index: 10000;
            pointer-events: none;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .verse-tooltip.active {
            display: block;
        }

        .verse-tooltip .tooltip-verse-number {
            font-weight: bold;
            color: #4CAF50;
            margin-right: 5px;
        }

        .verse-tooltip .tooltip-no-content {
            color: #aaa;
            font-style: italic;
        }

        .selection-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .verse-preview {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            margin-top: 15px;
            display: none;
        }

        .verse-preview.active {
            display: block;
        }

        .verse-preview-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .verse-content {
            line-height: 1.8;
            color: #555;
        }

        .verse-number {
            font-weight: bold;
            color: #4CAF50;
            margin-right: 5px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selected-count {
            color: #666;
            font-size: 14px;
        }

        .selected-count strong {
            color: #4CAF50;
            font-size: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-title">üîñ Ch·ªçn C√¢u Kinh Th√°nh</div>
        <div class="demo-description">
            Click v√†o √¥ b√™n d∆∞·ªõi ƒë·ªÉ ch·ªçn c√¢u Kinh Th√°nh. B·∫°n c√≥ th·ªÉ ch·ªçn nhi·ªÅu c√¢u.
            Ch·ªâ hi·ªÉn th·ªã c√°c s√°ch ƒë∆∞·ª£c ch·ªçn s·∫µn.
        </div>

        <div class="bible-verse-selector-wrapper">
            <div class="bible-verse-input" id="bibleVerseInput">
                <div class="input-content" id="inputContent">
                    <span class="input-placeholder">Click ƒë·ªÉ ch·ªçn c√¢u Kinh Th√°nh...</span>
                </div>
            </div>
            <div class="input-icon">üìñ</div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay"></div>

    <!-- Verse Tooltip -->
    <div class="verse-tooltip" id="verseTooltip">
        <div class="tooltip-content"></div>
    </div>

    <!-- Bible Verse Modal -->
    <div class="bible-verse-modal" id="bibleVerseModal">
        <div class="modal-header">
            <div class="modal-title">üìñ Ch·ªçn C√¢u Kinh Th√°nh</div>
            <div class="modal-close" id="modalClose">√ó</div>
        </div>

        <div class="modal-body">
            <div class="selector-row">
                <div class="form-group">
                    <label class="form-label">Ch·ªçn s√°ch:</label>
                    <select class="form-select" id="bookSelect">
                        <option value="">-- ƒêang t·∫£i... --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ch·ªçn ch∆∞∆°ng:</label>
                    <select class="form-select" id="chapterSelect">
                        <option value="">-- Ch·ªçn s√°ch tr∆∞·ªõc --</option>
                    </select>
                </div>
            </div>

            <div class="verse-grid-container" id="verseGridContainer">
                <div class="form-label">Ch·ªçn c√¢u (click 2 l·∫ßn ƒë·ªÉ ch·ªçn kho·∫£ng):</div>
                <div class="verse-grid" id="verseGrid"></div>

                <div class="selection-actions">
                    <button class="btn btn-primary" id="addVerse" disabled>‚úì Th√™m c√¢u n√†y</button>
                    <button class="btn btn-secondary" id="clearSelection">‚úï H·ªßy ch·ªçn</button>
                </div>

                <div class="verse-preview" id="versePreview">
                    <div class="verse-preview-title" id="versePreviewTitle">N·ªôi dung:</div>
                    <div class="verse-content" id="verseContent"></div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <div class="selected-count">
                ƒê√£ ch·ªçn: <strong id="selectedCount">0</strong> c√¢u
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" id="clearAll">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
                <button class="btn btn-primary" id="doneButton">‚úì Ho√†n t·∫•t</button>
            </div>
        </div>
    </div>

    <script>
        (function($) {
            // CONFIG: Edit this array to show only specific books
            const ALLOWED_BOOKS = [
                'Ma-thi-∆°',
                'M√°c',
                'Lu-ca',
                'GiƒÉng',
                'C√¥ng V·ª•',
                'R√¥-ma',
                'I C√¥-rinh-t√¥',
                'II C√¥-rinh-t√¥',
                'Ga-la-ti',
                '√ä-ph√™-s√¥',
                // Add more book names here as needed
            ];

            // Bible data will be loaded from API/JSON
            let bibleData = {};
            let bibleVerses = {};  // Full verse content (optional)
            let selectedVerses = [];
            let currentSelection = {
                book: null,
                chapter: null,
                verses: [],
                rangeStart: null
            };

            // Fallback data (structure only)
            function useFallbackData() {
                bibleData = {
                    'Ma-thi-∆°': {1:25,2:23,3:17,4:25,5:48,6:34,7:29,8:34,9:38,10:42,11:30,12:50,13:58,14:36,15:39,16:28,17:27,18:35,19:30,20:34,21:46,22:46,23:39,24:51,25:46,26:75,27:66,28:20},
                    'M√°c': {1:45,2:28,3:35,4:41,5:43,6:56,7:37,8:38,9:50,10:52,11:33,12:44,13:37,14:72,15:47,16:20},
                    'Lu-ca': {1:80,2:52,3:38,4:44,5:39,6:49,7:50,8:56,9:62,10:42,11:54,12:59,13:35,14:35,15:32,16:31,17:37,18:43,19:48,20:47,21:38,22:71,23:56,24:53},
                    'GiƒÉng': {1:51,2:25,3:36,4:54,5:47,6:71,7:53,8:59,9:41,10:42,11:57,12:50,13:38,14:31,15:27,16:33,17:26,18:40,19:42,20:31,21:25},
                    'C√¥ng V·ª•': {1:26,2:47,3:26,4:37,5:42,6:15,7:60,8:40,9:43,10:48,11:30,12:25,13:52,14:28,15:41,16:40,17:34,18:28,19:41,20:38,21:40,22:30,23:35,24:27,25:27,26:32,27:44,28:31},
                    'R√¥-ma': {1:32,2:29,3:31,4:25,5:21,6:23,7:25,8:39,9:33,10:21,11:36,12:21,13:14,14:23,15:33,16:27},
                    'I C√¥-rinh-t√¥': {1:31,2:16,3:23,4:21,5:13,6:20,7:40,8:13,9:27,10:33,11:34,12:31,13:13,14:40,15:58,16:24},
                    'II C√¥-rinh-t√¥': {1:24,2:17,3:18,4:18,5:21,6:18,7:16,8:24,9:15,10:18,11:33,12:21,13:14},
                    'Ga-la-ti': {1:24,2:21,3:29,4:31,5:26,6:18},
                    '√ä-ph√™-s√¥': {1:23,2:22,3:21,4:32,5:33,6:24}
                };
            }

            // Plugin
            $.fn.bibleVerseSelector = function(options) {
                const $input = $(this);
                const $modal = $('#bibleVerseModal');
                const $overlay = $('#modalOverlay');

                function initializeBooks() {
                    const $bookSelect = $('#bookSelect');
                    $bookSelect.empty().append('<option value="">-- Ch·ªçn s√°ch --</option>');

                    // Filter books based on ALLOWED_BOOKS array
                    $.each(bibleData, function(book) {
                        // Only show books in the allowed list
                        if (ALLOWED_BOOKS.length === 0 || ALLOWED_BOOKS.includes(book)) {
                            $bookSelect.append($('<option>', {
                                value: book,
                                text: book
                            }));
                        }
                    });
                }

                function updateChapters() {
                    const selectedBook = $('#bookSelect').val();
                    const $chapterSelect = $('#chapterSelect');

                    $chapterSelect.empty().append('<option value="">-- Ch·ªçn ch∆∞∆°ng --</option>');
                    clearVerseGrid();

                    if (selectedBook && bibleData[selectedBook]) {
                        const chapters = Object.keys(bibleData[selectedBook]);
                        $.each(chapters, function(i, chapter) {
                            $chapterSelect.append($('<option>', {
                                value: chapter,
                                text: 'Ch∆∞∆°ng ' + chapter
                            }));
                        });
                    }
                }

                function createVerseGrid() {
                    const book = $('#bookSelect').val();
                    const chapter = $('#chapterSelect').val();

                    if (!book || !chapter) {
                        clearVerseGrid();
                        return;
                    }

                    const verseCount = bibleData[book][chapter];
                    const $grid = $('#verseGrid');
                    $grid.empty();

                    for (let i = 1; i <= verseCount; i++) {
                        const $button = $('<button>', {
                            class: 'verse-button',
                            text: i,
                            'data-verse': i,
                            'data-book': book,
                            'data-chapter': chapter
                        });
                        $grid.append($button);
                    }

                    // Add hover event listeners for tooltips
                    $('.verse-button').on('mouseenter', function(e) {
                        showVerseTooltip(e);
                    }).on('mousemove', function(e) {
                        updateTooltipPosition(e);
                    }).on('mouseleave', function() {
                        hideVerseTooltip();
                    });

                    $('#verseGridContainer').addClass('active');

                    currentSelection.book = book;
                    currentSelection.chapter = chapter;
                    currentSelection.verses = [];
                    currentSelection.rangeStart = null;
                }

                function clearVerseGrid() {
                    $('#verseGrid').empty();
                    $('#verseGridContainer').removeClass('active');
                    $('#versePreview').removeClass('active');
                    $('#addVerse').prop('disabled', true);
                    currentSelection = {
                        book: null,
                        chapter: null,
                        verses: [],
                        rangeStart: null
                    };
                }

                function handleVerseClick(verseNum) {
                    if (currentSelection.rangeStart === null) {
                        $('.verse-button').removeClass('range-start range-end in-range');
                        $(`.verse-button[data-verse="${verseNum}"]`).addClass('range-start');
                        currentSelection.rangeStart = verseNum;
                        currentSelection.verses = [verseNum];
                        showVersePreview([verseNum]);
                    } else {
                        const start = Math.min(currentSelection.rangeStart, verseNum);
                        const end = Math.max(currentSelection.rangeStart, verseNum);

                        $('.verse-button').removeClass('range-start range-end in-range');

                        const verses = [];
                        for (let i = start; i <= end; i++) {
                            verses.push(i);
                            const $btn = $(`.verse-button[data-verse="${i}"]`);
                            if (i === start) {
                                $btn.addClass('range-start');
                            } else if (i === end) {
                                $btn.addClass('range-end');
                            } else {
                                $btn.addClass('in-range');
                            }
                        }

                        currentSelection.verses = verses;
                        showVersePreview(verses);
                    }

                    $('#addVerse').prop('disabled', currentSelection.verses.length === 0);
                }

                function showVersePreview(verses) {
                    const book = currentSelection.book;
                    const chapter = String(currentSelection.chapter); // Ensure chapter is string

                    console.log('showVersePreview called:', { book, chapter, verses });
                    console.log('bibleVerses available:', bibleVerses);
                    console.log('Check bibleVerses[book]:', bibleVerses[book]);
                    console.log('Check bibleVerses[book][chapter]:', bibleVerses[book]?.[chapter]);

                    let content = '';
                    let hasContent = false;

                    // If you have verse content loaded
                    if (bibleVerses[book] && bibleVerses[book][chapter]) {
                        $.each(verses, function(i, verseNum) {
                            const verseText = bibleVerses[book][chapter][String(verseNum)]; // Ensure verse is string
                            console.log(`Verse ${verseNum}:`, verseText);
                            if (verseText) {
                                hasContent = true;
                                content += `<span class="verse-number">${verseNum}</span>${verseText}<br><br>`;
                            }
                        });
                    }

                    if (hasContent) {
                        $('#verseContent').html(content);
                        $('#versePreview').addClass('active');

                        if (verses.length === 1) {
                            $('#versePreviewTitle').text(`N·ªôi dung c√¢u ${verses[0]}:`);
                        } else {
                            $('#versePreviewTitle').text(`N·ªôi dung c√°c c√¢u ${verses[0]}-${verses[verses.length-1]}:`);
                        }
                    } else {
                        console.log('No verse content found, showing default message');
                        $('#verseContent').html('<em style="color: #999;">Ch∆∞a c√≥ n·ªôi dung cho c√¢u n√†y</em>');
                        $('#versePreview').addClass('active');
                    }
                }

                function addVerse() {
                    if (currentSelection.verses.length === 0) return;

                    const book = currentSelection.book;
                    const chapter = currentSelection.chapter;
                    const verses = currentSelection.verses;

                    let verseText;
                    if (verses.length === 1) {
                        verseText = `${book} ${chapter}:${verses[0]}`;
                    } else {
                        verseText = `${book} ${chapter}:${verses[0]}-${verses[verses.length-1]}`;
                    }

                    if (selectedVerses.some(v => v.text === verseText)) {
                        alert('‚ö†Ô∏è C√¢u n√†y ƒë√£ ƒë∆∞·ª£c th√™m r·ªìi!');
                        return;
                    }

                    selectedVerses.push({
                        text: verseText,
                        book: book,
                        chapter: chapter,
                        verses: verses.slice()
                    });

                    updateInput();
                    updateSelectedCount();
                    clearCurrentSelection();
                }

                function clearCurrentSelection() {
                    $('.verse-button').removeClass('range-start range-end in-range');
                    currentSelection.verses = [];
                    currentSelection.rangeStart = null;
                    $('#versePreview').removeClass('active');
                    $('#addVerse').prop('disabled', true);
                }

                function updateInput() {
                    const $content = $('#inputContent');
                    $content.empty();

                    if (selectedVerses.length === 0) {
                        $content.html('<span class="input-placeholder">Click ƒë·ªÉ ch·ªçn c√¢u Kinh Th√°nh...</span>');
                    } else {
                        $.each(selectedVerses, function(index, verse) {
                            const $tag = $('<span>', { class: 'verse-tag' });
                            $tag.append($('<span>', { text: verse.text }));

                            const $remove = $('<span>', {
                                class: 'verse-tag-remove',
                                text: '√ó',
                                'data-index': index
                            });

                            $tag.append($remove);
                            $content.append($tag);
                        });
                    }
                }

                function updateSelectedCount() {
                    $('#selectedCount').text(selectedVerses.length);
                }

                function removeVerse(index) {
                    selectedVerses.splice(index, 1);
                    updateInput();
                    updateSelectedCount();
                }

                function clearAll() {
                    if (selectedVerses.length > 0 && !confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£?')) {
                        return;
                    }
                    selectedVerses = [];
                    updateInput();
                    updateSelectedCount();
                }

                // Tooltip functions
                function showVerseTooltip(e) {
                    const $button = $(e.currentTarget);
                    const verseNum = String($button.data('verse')); // Ensure string
                    const book = $button.data('book');
                    const chapter = String($button.data('chapter')); // Ensure string

                    const $tooltip = $('#verseTooltip');
                    const $tooltipContent = $tooltip.find('.tooltip-content');

                    // Get verse text if available
                    let content = '';
                    if (bibleVerses[book] && bibleVerses[book][chapter] && bibleVerses[book][chapter][verseNum]) {
                        const verseText = bibleVerses[book][chapter][verseNum];
                        content = `<span class="tooltip-verse-number">${verseNum}.</span>${verseText}`;
                    } else {
                        content = `<span class="tooltip-verse-number">${verseNum}.</span><span class="tooltip-no-content">Ch∆∞a c√≥ n·ªôi dung</span>`;
                    }

                    $tooltipContent.html(content);
                    $tooltip.addClass('active');
                    updateTooltipPosition(e);
                }

                function updateTooltipPosition(e) {
                    const $tooltip = $('#verseTooltip');
                    const offset = 15;
                    let left = e.pageX + offset;
                    let top = e.pageY + offset;

                    // Get tooltip dimensions
                    const tooltipWidth = $tooltip.outerWidth();
                    const tooltipHeight = $tooltip.outerHeight();
                    const windowWidth = $(window).width();
                    const windowHeight = $(window).height();

                    // Adjust if tooltip goes off screen horizontally
                    if (left + tooltipWidth > windowWidth) {
                        left = e.pageX - tooltipWidth - offset;
                    }

                    // Adjust if tooltip goes off screen vertically
                    if (top + tooltipHeight > windowHeight) {
                        top = e.pageY - tooltipHeight - offset;
                    }

                    $tooltip.css({
                        left: left + 'px',
                        top: top + 'px'
                    });
                }

                function hideVerseTooltip() {
                    $('#verseTooltip').removeClass('active');
                }

                function openModal() {
                    $modal.addClass('active');
                    $overlay.addClass('active');
                    $input.addClass('focused');
                    $('body').css('overflow', 'hidden');
                }

                function closeModal() {
                    $modal.removeClass('active');
                    $overlay.removeClass('active');
                    $input.removeClass('focused');
                    $('body').css('overflow', '');
                    clearCurrentSelection();
                    hideVerseTooltip(); // Hide tooltip when closing modal
                }

                // Event handlers
                $input.on('click', function(e) {
                    if (!$(e.target).hasClass('verse-tag-remove')) {
                        openModal();
                    }
                });

                $(document).on('click', '.verse-tag-remove', function(e) {
                    e.stopPropagation();
                    const index = $(this).data('index');
                    removeVerse(index);
                });

                $('#modalClose, #doneButton').on('click', closeModal);

                $overlay.on('click', closeModal);

                $('#bookSelect').on('change', updateChapters);
                $('#chapterSelect').on('change', createVerseGrid);

                $(document).on('click', '.verse-button', function() {
                    const verse = parseInt($(this).data('verse'));
                    handleVerseClick(verse);
                });

                $('#addVerse').on('click', addVerse);
                $('#clearSelection').on('click', clearCurrentSelection);
                $('#clearAll').on('click', clearAll);

                // ESC to close
                $(document).on('keydown', function(e) {
                    if (e.key === 'Escape' && $modal.hasClass('active')) {
                        closeModal();
                    }
                });

                // Initialize
                initializeBooks();
                updateInput();
                updateSelectedCount();

                return {
                    getSelectedVerses: function() {
                        return selectedVerses.map(v => v.text);
                    },
                    getValue: function() {
                        return selectedVerses.map(v => v.text).join('; ');
                    },
                    clearAll: clearAll
                };
            };

            // Load Bible data then initialize plugin
            function initializeApp() {
                $.ajax({
                    url: 'bible.json',
                    dataType: 'json',
                    success: function(data) {
                        bibleData = data.structure || data;
                        bibleVerses = data.verses || {};
                        console.log('Bible data loaded successfully');
                        console.log('Sample verse check - Ma-thi-∆° 1:1:', bibleVerses['Ma-thi-∆°']?.[1]?.[1]);

                        // Initialize plugin after data is loaded
                        const selector = $('#bibleVerseInput').bibleVerseSelector();
                        window.bibleSelector = selector;
                    },
                    error: function(xhr, status, error) {
                        console.warn('Could not load bible.json, using fallback data. Error:', error);
                        useFallbackData();

                        // Initialize plugin with fallback data
                        const selector = $('#bibleVerseInput').bibleVerseSelector();
                        window.bibleSelector = selector;
                    }
                });
            }

            // Start the app
            initializeApp();

        })(jQuery);
    </script>
</body>
</html>
